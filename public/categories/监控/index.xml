<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
    <channel>
        <title>监控 on 千兆光年&#39;s Blog</title>
        <link>http://localhost:1313/categories/%E7%9B%91%E6%8E%A7/</link>
        <description>Recent content in 监控 on 千兆光年&#39;s Blog</description>
        <generator>Hugo -- gohugo.io</generator>
        <language>zh-cn</language>
        <copyright>OyFaCC</copyright>
        <lastBuildDate>Fri, 04 Sep 2020 16:10:02 +0800</lastBuildDate><atom:link href="http://localhost:1313/categories/%E7%9B%91%E6%8E%A7/index.xml" rel="self" type="application/rss+xml" /><item>
        <title>Prometheus本地存储</title>
        <link>http://localhost:1313/p/prometheus%E6%9C%AC%E5%9C%B0%E5%AD%98%E5%82%A8/</link>
        <pubDate>Fri, 04 Sep 2020 16:10:02 +0800</pubDate>
        
        <guid>http://localhost:1313/p/prometheus%E6%9C%AC%E5%9C%B0%E5%AD%98%E5%82%A8/</guid>
        <description>&lt;p&gt;Prometheus（普罗米修斯）存储经历了三个重要版本的变更v1&amp;gt;v2&amp;gt;v3，下面简述下各自版本的缺点。&lt;/p&gt;
&lt;h3 id=&#34;v1&#34;&gt;v1
&lt;/h3&gt;&lt;p&gt;2012年发布，整个数据被分为数据和原数据两部分，然后被保存在LevelDB中，并且每隔15分钟刷新一次，这样会有一个严重的问题，如果主机当机，会最长丢失15分钟的数据。v1版本有性能问题，每秒只能支持50000个样本的写入。10s周期，1000个指标，大约只能支撑500台机器的指标收集。&lt;/p&gt;
&lt;h3 id=&#34;v2&#34;&gt;v2
&lt;/h3&gt;&lt;p&gt;针对v1的问题，2015年发布了V2版本，这时候，每个时序数据用单个的文件保存，性能提高至800000样本。但是每个时序都对应一个文件，产生了严重的时序流失和写放大问题，内存使用率不断增加，经常发生OOM，同事大量文件的创建，造成了内核文件句柄过多的错误。&lt;/p&gt;
&lt;h3 id=&#34;v3&#34;&gt;v3
&lt;/h3&gt;&lt;p&gt;针对V2的问题，2017年发布了v3版本，解决了下面的问题&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;当机数据丢失的问题，引入WAL&lt;/li&gt;
&lt;li&gt;每秒1000 0000个样本接受&lt;/li&gt;
&lt;li&gt;CPU下降3倍，磁盘IO下降10倍&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;普罗米修斯的本地存储也被称之为Prometheus TSDB，TSDB的设计核心包含两个，WAL和block，block有包含chunk，meta.json，index，tombstones。&lt;/p&gt;
&lt;p&gt;最新的block被称之为head block，支持读写，其他block只读方式存储在硬盘中。&lt;/p&gt;
&lt;h5 id=&#34;block&#34;&gt;block
&lt;/h5&gt;&lt;p&gt;按照时间分割成block，大小不固定，按照设定的步数生成block，如：步数3，默认两小时，则第一次两小时生成一个，6小时生成一个，18小时生成一个，生成了三次。而且block会自动合并，如将3个2小时合并成一个6小时的，减少block的个数。每个block有全局唯一的uuid，这个是包含时间戳的，可以方便的排序。&lt;/p&gt;
&lt;p&gt;block内部包含如下的几部分&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;chunks 压缩后的时序数据，每个大小512M&lt;/li&gt;
&lt;li&gt;index 索引，为快速查询提供的索引，&lt;/li&gt;
&lt;li&gt;tombstones，用于对数据进行软删除，如果一个block删除了部分数据，可用这个&lt;/li&gt;
&lt;li&gt;meta.json 记录了block的原数据信息，开始时间，截止时间，样本数等&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&#34;http://cdn.oyfacc.cn/prometheus-tsdb.png&#34;
	
	
	
	loading=&#34;lazy&#34;
	
		alt=&#34;tsdb&#34;
	
	
&gt;&lt;/p&gt;
&lt;h5 id=&#34;wal&#34;&gt;WAL
&lt;/h5&gt;&lt;p&gt;为了防止为写入磁盘的数据丢失，引入了这个机制&lt;/p&gt;
&lt;h3 id=&#34;相关参数&#34;&gt;相关参数
&lt;/h3&gt;&lt;p&gt;数据保存的相关参数&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&amp;ndash;storage.tsdb.retention 存储时间，默认15天&lt;/li&gt;
&lt;li&gt;&amp;ndash;storage.tsdb.parh  存储路径&lt;/li&gt;
&lt;/ul&gt;
</description>
        </item>
        
    </channel>
</rss>
